# CSV客户信息查询工具 v2.0

这是一个 Tampermonkey 用户脚本，用于批量查询客户信息并将结果添加到CSV文件中。

## ✨ v2.0 新特性

- 🎯 **智能请求拦截** - 自动捕获真实API请求参数，无需手动配置
- ⚙️ **配置管理面板** - 可视化配置状态，一键捕获和重置
- 🔒 **安全验证** - 配置有效期检测，Token脱敏显示
- 🚀 **更高准确性** - 使用100%真实的API参数，完全避免参数猜测

## 功能特点

- 📊 支持上传CSV文件（分号或逗号分隔）
- 🔍 自动调用API查询3.0和4.0客户信息
- 📈 实时显示处理进度
- 💾 导出处理后的CSV文件
- 🎯 自动拦截并捕获API配置（v2.0新增）
- ⚙️ 智能配置管理和过期检测（v2.0新增）

## 安装步骤

1. 安装 [Tampermonkey](https://www.tampermonkey.net/) 浏览器扩展
2. 打开 Tampermonkey 管理面板
3. 点击"添加新脚本"
4. 复制 `csv_client_mapper.user.js` 的全部内容并粘贴
5. 保存脚本（Ctrl+S 或 Cmd+S）

## 使用方法

### 🚀 快速开始

**首次使用必须先配置API参数！** 详见 [快速开始指南](QUICK_START.md)

### 步骤 0: 配置API参数（首次使用）

**v2.0 新增：智能请求拦截配置**

1. **登录ops平台**
   ```
   访问 https://ops.planetmeican.com 并登录
   ```

2. **启动捕获模式**
   - 打开CSV工具
   - 在"⚙️ API配置"区域点击"🎯 开始捕获请求"

3. **触发API请求**
   - 在ops网站搜索框输入任意客户ID并搜索
   - 工具会自动捕获所有API参数

4. **配置完成**
   - 看到"✅ 已配置"提示即表示成功
   - 配置有效期7天，过期后需要重新捕获

### 步骤 1: 打开工具

- 在任意网页右上角，点击"📊 CSV工具"按钮
- 工具面板会从右侧滑出
- 确认配置状态为"✅ 已配置"

### 步骤 2: 上传CSV文件

- 点击"选择文件"按钮
- 选择你的CSV文件（必须包含客户ID列）
- 工具会自动显示文件信息：行数、列数、列名

### 步骤 3: 配置列名

- 从下拉菜单中选择"3.0客户ID列名"
- 从下拉菜单中选择"4.0客户ID列名"
- 工具会尝试智能识别包含"legacy_client"和"new_client"的列

### 步骤 4: 开始处理

- 点击"开始处理"按钮
- 工具会逐行查询API，获取客户名称
- 进度条会实时显示处理进度

5. **下载结果**
   - 处理完成后，点击"下载处理后的CSV"
   - 文件会自动下载到浏览器默认下载文件夹
   - 文件名格式：`processed_[时间戳].csv`

## CSV文件格式要求

### 输入格式

你的CSV文件应该包含以下列（列名可以不同）：
```
id;name;patterns;new_client_ids;legacy_client_ids
6969557115499593728;魔盒;["/api/v1/..."];[129227861807661103];[75318110158621733]
```

支持的分隔符：
- 分号 (`;`)
- 逗号 (`,`)

特殊格式支持：
- ✅ 方括号内的内容（如 `[123, 456]`）
- ✅ 引号内的内容
- ✅ `null` 值

### 输出格式

处理后的CSV会在原有列的基础上，新增两列：
- `3.0客户`：3.0客户的名称
- `4.0客户`：4.0客户的名称

如果查询失败或未找到，会显示"查询失败"或留空。

## 技术细节

### 认证机制

工具会从以下位置自动获取认证token：
1. Cookie中的 `token`、`auth_token` 或 `authorization`
2. localStorage中的 `token` 或 `auth_token`

### API调用

- 接口：`/napi/v1/developer-team/search-resources`
- 方法：POST
- 资源类型：
  - 3.0客户：`RESOURCE_TYPE_LEGACY_CLIENT`
  - 4.0客户：`RESOURCE_TYPE_CLIENT`

### 处理速度

- 每行处理延迟：100ms
- 避免请求过于频繁导致限流
- 47行数据约需5-10秒

## 常见问题

### Q: 提示"未找到认证token"怎么办？

A: 请确保：
1. 已在浏览器中打开 `https://ops.planetmeican.com`
2. 已成功登录
3. 登录后再使用本工具

### Q: CSV只识别到1列怎么办？

A: 这个问题已在v1.2版本修复。请确保使用最新版本的脚本。

### Q: 部分客户显示"查询失败"？

A: 可能原因：
1. 客户ID不存在
2. API调用失败
3. 网络问题

查看浏览器控制台（F12）查看详细错误信息。

### Q: 可以在哪些网站使用？

A: 本工具可以在任何网站使用（`@match *://*/*`），但需要先登录 ops.planetmeican.com 获取认证信息。

## 更新日志

### v1.2 (2025-01-17)
- ✅ 修复CSV解析问题，正确处理方括号内的分号
- ✅ 添加自动认证token获取功能
- ✅ 添加登录状态检查
- ✅ 改进错误提示

### v1.1 (2025-01-17)
- ✅ 添加分隔符自动检测
- ✅ 支持逗号和分号分隔

### v1.0 (2025-01-17)
- 🎉 初始版本发布

## 许可证

MIT License

## 支持

如有问题，请联系开发团队。
